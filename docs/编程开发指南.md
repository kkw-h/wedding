# ğŸ“‚ Project: Wedding SaaS Admin Panel (Technical Spec)

## 1. æŠ€æœ¯æ ˆä¸Šä¸‹æ–‡ (Tech Stack Context)
*   **Frontend:** Vue 3, Ant Design Pro
*   **Backend:**  Python (FastAPI).
*   **Database:** PostgreSQL.
*   **State Management:**  Pinia.
*   **Auth:** JWT (JSON Web Token) + RBAC (Role-Based Access Control).

---

## 2. æ•°æ®åº“æ¨¡å‹è®¾è®¡ (Database Schema)

è¯·åŸºäºä»¥ä¸‹ä¼ªä»£ç  (Pseudo-SQL) ç”Ÿæˆ Migration æ–‡ä»¶å’Œ ORM æ¨¡å‹ã€‚

```sql
-- 1. ç”¨æˆ·ä¸è§’è‰²
ENUM RoleType { ADMIN, MANAGER, PLANNER, VENDOR, FINANCE }

TABLE users {
  id: UUID [PK]
  username: VARCHAR
  password_hash: VARCHAR
  role: RoleType
  team_id: UUID [FK] -- æ‰€å±å›¢é˜Ÿ/é—¨åº—
  is_active: BOOLEAN
}

-- 2. çº¿ç´¢ (CRM)
ENUM LeadStatus { NEW, CONTACTING, VISITED, INTENTIONAL, WON, LOST, PUBLIC_POOL }

TABLE leads {
  id: UUID [PK]
  customer_name: VARCHAR
  phone: VARCHAR [UNIQUE] -- æ‰‹æœºå·å”¯ä¸€ï¼Œç”¨äºæŸ¥é‡
  wedding_date: DATE
  budget_min: DECIMAL
  budget_max: DECIMAL
  owner_id: UUID [FK] -- å½“å‰è´Ÿè´£äºº
  last_contact_at: TIMESTAMP -- ç”¨äºåˆ¤å®šæ‰å…¥å…¬æµ·
  source: VARCHAR
  status: LeadStatus
}

-- 3. é¡¹ç›® (Project)
ENUM ProjectStage { PREPARING, DESIGNING, EXECUTING, COMPLETED, ARCHIVED }

TABLE projects {
  id: UUID [PK]
  lead_id: UUID [FK]
  name: VARCHAR
  wedding_date: DATE
  hotel_name: VARCHAR
  total_budget: DECIMAL
  stage: ProjectStage
  is_presentation_mode: BOOLEAN [DEFAULT: false] -- å‰ç«¯çŠ¶æ€ï¼ŒéæŒä¹…åŒ–
}

-- 4. æŠ¥ä»·ä¸æˆæœ¬ (Budget & Cost)
TABLE budget_items {
  id: UUID [PK]
  project_id: UUID [FK]
  category: VARCHAR -- e.g., "é²œèŠ±", "ç¯å…‰"
  name: VARCHAR
  unit_price: DECIMAL -- å¯¹å®¢å•ä»·
  cost_price: DECIMAL -- å†…éƒ¨æˆæœ¬ (æ•æ„Ÿå­—æ®µ)
  quantity: INTEGER
  supplier_id: UUID [FK, NULLABLE] -- å…³è”ä¾›åº”å•†
  is_locked: BOOLEAN -- å®¡æ‰¹é€šè¿‡åé”å®š
}

-- 5. å®¡æ‰¹æµ (Approval)
ENUM ApprovalType { DISCOUNT, PAYMENT, REFUND }
ENUM ApprovalStatus { PENDING, APPROVED, REJECTED }

TABLE approvals {
  id: UUID [PK]
  project_id: UUID [FK]
  requester_id: UUID [FK]
  approver_id: UUID [FK]
  type: ApprovalType
  current_data: JSONB -- ç”³è¯·æ—¶çš„å¿«ç…§æ•°æ®
  status: ApprovalStatus
  audit_log: TEXT
}
```

---

## 3. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (Business Logic & Rules)

è¯·åœ¨ Service å±‚å®ç°ä»¥ä¸‹é€»è¾‘ï¼š

### A. æƒé™æ§åˆ¶ä¸­é—´ä»¶ (RBAC Middleware)
*   **è§„åˆ™ï¼š** æ‰€æœ‰ API è¯·æ±‚éœ€æ‹¦æˆªæ ¡éªŒ `req.user.role`ã€‚
*   **æ•°æ®è„±æ• (Data Masking):**
    *   IF `role` == `PLANNER` OR `VENDOR`:
        *   åœ¨æŸ¥è¯¢ `budget_items` æ—¶ï¼Œå¼ºåˆ¶å°† `cost_price` å­—æ®µç½®ä¸º `null` æˆ– `0`ã€‚
        *   ç¦æ­¢è®¿é—® `profit_margin` (æ¯›åˆ©) è®¡ç®—é€»è¾‘ã€‚
    *   IF `role` == `ADMIN` OR `MANAGER`:
        *   è¿”å›å®Œæ•´æ•°æ®ã€‚

### B. çº¿ç´¢å…¬æµ·æœºåˆ¶ (Lead Recycling Job)
*   **è§¦å‘å™¨ï¼š** æ¯æ—¥å‡Œæ™¨ 02:00 æ‰§è¡Œ Cron Jobã€‚
*   **é€»è¾‘ï¼š**
    ```typescript
    const thresholdDate = new Date();
    thresholdDate.setDate(thresholdDate.getDate() - 15); // 15å¤©é˜ˆå€¼

    // æŸ¥æ‰¾æ‰€æœ‰ç§æœ‰çº¿ç´¢ä¸”15å¤©æœªè·Ÿè¿›
    const staleLeads = await leadRepo.find({
      where: {
        owner_id: Not(IsNull()),
        last_contact_at: LessThan(thresholdDate),
        status: Not(In([LeadStatus.WON, LeadStatus.LOST]))
      }
    });

    // æ›´æ–°ä¸ºå…¬æµ·æ± 
    staleLeads.forEach(lead => {
      lead.owner_id = null;
      lead.status = LeadStatus.PUBLIC_POOL;
      lead.audit_logs.push("ç³»ç»Ÿè‡ªåŠ¨å›æ”¶è‡³å…¬æµ·");
    });
    ```

### C. æ’å•æ£€æµ‹ (Conflict Check)
*   **API:** `POST /api/leads/check-conflict`
*   **é€»è¾‘ï¼š** æ¥æ”¶ `phone`ã€‚æŸ¥è¯¢ `leads` è¡¨ã€‚
    *   å¦‚æœå­˜åœ¨ä¸” `owner_id` ä¸ä¸ºç©º -> è¿”å› `{ conflict: true, owner_name: "å¼ ä¸‰" }`ã€‚
    *   å¦‚æœä¸å­˜åœ¨æˆ– `owner_id` ä¸ºç©º -> è¿”å› `{ conflict: false }`ã€‚

---

## 4. å‰ç«¯ç»„ä»¶è§„èŒƒ (Frontend Component Specs)

è¯·ç”Ÿæˆç¬¦åˆä»¥ä¸‹è¦æ±‚çš„ Vue ç»„ä»¶ï¼š

### A. æ•æ„Ÿæ•°æ®é®ç½©ç»„ä»¶ (`SensitiveText`)
*   **Props:** `value: string | number`, `maskChar: string` (default '*').
*   **Global Context:** ç›‘å¬å…¨å±€çŠ¶æ€ `PresentationMode` (æ¼”ç¤ºæ¨¡å¼)ã€‚
*   **é€»è¾‘ï¼š**
    *   å¦‚æœ `PresentationMode === true`ï¼Œæ¸²æŸ“ `******`ã€‚
    *   å¦‚æœ `PresentationMode === false`ï¼Œæ¸²æŸ“çœŸå® `value`ã€‚
*   **ç”¨é€”ï¼š** ç”¨äºåŒ…è£¹æ‰€æœ‰æ¶‰åŠé‡‘é¢çš„ UI å…ƒç´ ã€‚

### B. æŠ¥ä»·å•ç¼–è¾‘å™¨ (`QuotationBuilder`)
*   **ç»“æ„ï¼š** æ‹–æ‹½å¼è¡¨æ ¼ (Draggable Table)ã€‚
*   **åŠŸèƒ½ï¼š**
    *   æ”¯æŒè¡Œæ’åº (Row Sort)ã€‚
    *   å®æ—¶è®¡ç®—ï¼š`Total = Sum(Item.unit_price * Item.quantity)`ã€‚
    *   **è‡ªåŠ¨ä¿å­˜é’©å­ (Hook):** `useAutoSave(data, endpoint)`ï¼Œæ¯ 30 ç§’æˆ–æ•°æ®å˜æ›´å 2 ç§’é˜²æŠ–è§¦å‘ä¿å­˜ã€‚

### C. ç§»åŠ¨ç«¯é¢„è§ˆæ¨¡æ€æ¡† (`MobilePreviewModal`)
*   **UI:** ä½¿ç”¨ CSS ç»˜åˆ¶ä¸€ä¸ª iPhone å¤–å£³ (`border-radius: 40px`, `box-shadow`).
*   **Content:** å†…éƒ¨ä½¿ç”¨ `iframe` åŠ è½½ç§»åŠ¨ç«¯ H5 é¡µé¢ URLï¼Œæˆ–è€…æ¸²æŸ“ç§»åŠ¨ç«¯ä¸“ç”¨ç»„ä»¶ã€‚
*   **Scale:** å¿…é¡»æ”¯æŒ `transform: scale(0.8)` ä»¥é€‚åº”ç¬”è®°æœ¬å°å±å¹•ã€‚

---

## 5. API æ¥å£æ¸…å• (API Endpoints)

éµå¾ª RESTful è§„èŒƒï¼š

| Method | Endpoint | Description | Access Level |
| :--- | :--- | :--- | :--- |
| **GET** | `/api/dashboard/stats` | è·å–ä»ªè¡¨ç›˜æ•°æ® (æ ¹æ®è§’è‰²è¿”å›ä¸åŒå­—æ®µ) | All |
| **POST** | `/api/leads` | åˆ›å»ºçº¿ç´¢ (å«æ’å•æ ¡éªŒ) | Manager, Planner |
| **PUT** | `/api/leads/:id/claim` | ä»å…¬æµ·æ± æå–çº¿ç´¢ | Planner |
| **GET** | `/api/projects/:id` | è·å–é¡¹ç›®è¯¦æƒ… (å« Row-Level Security æ ¡éªŒ) | Owner, Manager, Admin |
| **POST** | `/api/approvals` | å‘èµ·å®¡æ‰¹ (æŠ˜æ‰£/ä»˜æ¬¾) | Planner |
| **PATCH** | `/api/approvals/:id/decide` | å®¡æ‰¹å†³ç­– (åŒæ„/æ‹’ç») | Manager, Admin |
| **GET** | `/api/resources/staff` | è·å–äººå‘˜åº“ (Planner åªèƒ½çœ‹åŸºç¡€ä¿¡æ¯) | All |

---

## 6. å¼€å‘ä»£ç ç›®å½•

ç®¡ç†åå° - web-admin
å°ç¨‹åº - mini-app
API - wedding-api